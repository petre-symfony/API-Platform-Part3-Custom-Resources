<?php
namespace App\DataTransformer;


use ApiPlatform\Core\DataTransformer\DataTransformerInterface;
use ApiPlatform\Core\Serializer\AbstractItemNormalizer;
use ApiPlatform\Core\Validator\ValidatorInterface;
use App\DTO\CheeseListingInput;
use App\Entity\CheeseListing;

class CheeseListingInputDataTransformer implements DataTransformerInterface {
  private ValidatorInterface $validator;

  public function __construct(ValidatorInterface $validator){

    $this->validator = $validator;
  }

  /**
   * @param CheeseListingInput $input
   */
  public function transform($input, string $to, array $context = []){
    $this->validator->validate($input);

    $cheeseListing = $context[AbstractItemNormalizer::OBJECT_TO_POPULATE] ?? null;

    return $input->createOrUpdateEntity($cheeseListing);
  }

  public function supportsTransformation($data, string $to, array $context = []): bool {
    if ($data instanceof CheeseListing) {
      //already transformed
      return false;
    }

    return $to===CheeseListing::CLASS && ($context['input']['class'] ?? null) === CheeseListingInput::class;
  }

}